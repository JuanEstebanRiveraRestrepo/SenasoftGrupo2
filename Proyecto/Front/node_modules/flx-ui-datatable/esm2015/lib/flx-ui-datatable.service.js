/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { Http, Headers } from '@angular/http';
import { map, retry } from 'rxjs/operators';
import { BehaviorSubject } from 'rxjs';
export class FlxUiDatatableService {
    /**
     * @param {?} http
     */
    constructor(http) {
        this.http = http;
        this.dataUrl = '';
        this.behavior = new BehaviorSubject([]);
        this.flxData = this.behavior.asObservable();
        this.pagination = [];
        this.totalItems = 0;
        this.dataOffset = 0;
        this.limit = 20;
        this.dataSrcKey = '';
        //Hold items selected for multiple select
        this.multipleDeletion = [];
        //Keep track if API call is completed
        this.loadFinish = false;
        this.lazyloadingConfig = {};
        this.processedData = {};
    }
    /**
     * @param {?} config
     * @return {?}
     */
    setLazyloadingConfig(config) {
        this.lazyloadingConfig = config;
    }
    /**
     *
     * @param {?} url User api rul
     * @return {?}
     */
    getData(url) {
        let /** @type {?} */ headers = new Headers();
        headers.append('Content-Type', 'application/x-www-form-urlencoded');
        return this.http.get(url, { headers: headers }).pipe(retry(5), map((response) => response.json()));
    }
    /**
     *
     * @param {?} url Service api url
     * @param {?} id Datatype id to export
     * @param {?} data Data to export
     * @return {?}
     */
    postData(url, id, data) {
        let /** @type {?} */ headers = new Headers();
        headers.append('Content-Type', 'application/json; charset=utf-8');
        return this.http.post(url + id, data, { headers: headers }).pipe(map((resp) => resp.json()));
    }
    /**
     *
     * @param {?} dataUrl Set dataurl
     * @return {?}
     */
    setDataUrl(dataUrl) {
        this.dataUrl = dataUrl;
    }
    /**
     * @return {?}
     */
    getDataUrl() {
        return this.dataUrl;
    }
    /**
     *
     * @param {?} data Register new data from user API
     * @return {?}
     */
    chageDataTable(data) {
        this.behavior.next(data);
    }
    /**
     *
     * @param {?} numberOfList Total number of list
     * @param {?} limit Pagination limit
     * @return {?}
     */
    createPagination(numberOfList, limit) {
        let /** @type {?} */ obj = [];
        let /** @type {?} */ counter = 1;
        for (let /** @type {?} */ i = 0; i < numberOfList; i += limit) {
            obj.push({ label: counter, value: i });
            counter++;
        }
        if (!this.isLazyLoadingEnabled) {
            obj.push({ label: 'All', value: 'all' });
        }
        return obj;
    }
    /**
     * @return {?}
     */
    isLazyLoadingEnabled() {
        return this.lazyloadingConfig.hasOwnProperty("apiOffsetKey") && this.lazyloadingConfig.apiOffsetKey;
    }
    /**
     * @param {?} dataUrl
     * @param {?=} setSelectPagination
     * @return {?}
     */
    loadFlxDataTableData(dataUrl, setSelectPagination = true) {
        this.loadFinish = false;
        this.loader = this.getData(dataUrl).subscribe((responseData) => {
            try {
                this.multipleDeletion = [];
                var /** @type {?} */ data = (this.dataSrcKey) ? responseData[this.dataSrcKey] : responseData;
                this.chageDataTable(data);
                if (this.isLazyLoadingEnabled()) {
                    this.totalItems = responseData.total;
                    // Handle 1 pagination out of zero problem 1/0  instead of 0/0 if no data is comming
                    if (data.length > 0) {
                        this.dataOffset = this.dataOffset + this.limit;
                    }
                }
                else {
                    this.totalItems = data.length;
                    this.dataOffset = 1;
                }
                if (setSelectPagination) {
                    if (this.isLazyLoadingEnabled()) {
                        this.pagination = this.createPagination(responseData.total, this.limit);
                    }
                    else {
                        this.pagination = this.createPagination(data.length, this.limit);
                    }
                }
                this.loadFinish = true;
            }
            catch (/** @type {?} */ e) {
                console.log('Error in reading data in ', e);
            }
        }, (e => {
            this.loadFinish = true;
        }));
    }
    /**
     * @return {?}
     */
    cancelLoading() {
        this.loader.unsubscribe();
    }
    /**
     * @param {?} srcKey
     * @return {?}
     */
    setDataSrcKey(srcKey) {
        this.dataSrcKey = srcKey;
    }
    /**
     * @return {?}
     */
    getDataLength() {
        return new Promise((resolve) => {
            this.flxData.subscribe((resp) => {
                resolve(resp.length);
            }, (e => {
                resolve(0);
            }));
        });
    }
}
FlxUiDatatableService.decorators = [
    { type: Injectable },
];
/** @nocollapse */
FlxUiDatatableService.ctorParameters = () => [
    { type: Http }
];
function FlxUiDatatableService_tsickle_Closure_declarations() {
    /** @type {?} */
    FlxUiDatatableService.prototype.dataUrl;
    /** @type {?} */
    FlxUiDatatableService.prototype.behavior;
    /** @type {?} */
    FlxUiDatatableService.prototype.flxData;
    /** @type {?} */
    FlxUiDatatableService.prototype.pagination;
    /** @type {?} */
    FlxUiDatatableService.prototype.totalItems;
    /** @type {?} */
    FlxUiDatatableService.prototype.dataOffset;
    /** @type {?} */
    FlxUiDatatableService.prototype.limit;
    /** @type {?} */
    FlxUiDatatableService.prototype.dataSrcKey;
    /** @type {?} */
    FlxUiDatatableService.prototype.multipleDeletion;
    /** @type {?} */
    FlxUiDatatableService.prototype.loader;
    /** @type {?} */
    FlxUiDatatableService.prototype.loadFinish;
    /** @type {?} */
    FlxUiDatatableService.prototype.lazyloadingConfig;
    /** @type {?} */
    FlxUiDatatableService.prototype.processedData;
    /** @type {?} */
    FlxUiDatatableService.prototype.http;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmx4LXVpLWRhdGF0YWJsZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vZmx4LXVpLWRhdGF0YWJsZS8iLCJzb3VyY2VzIjpbImxpYi9mbHgtdWktZGF0YXRhYmxlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUU7QUFDNUMsT0FBTyxFQUFFLElBQUksRUFBQyxPQUFPLEVBQVUsTUFBTSxlQUFlLENBQUU7QUFDdEQsT0FBTyxFQUFFLEdBQUcsRUFBQyxLQUFLLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBRTtBQUM1QyxPQUFPLEVBQWtCLGVBQWUsRUFBZSxNQUFNLE1BQU0sQ0FBQztBQUVwRSxNQUFNOzs7O0lBeUJKLFlBQW1CLElBQVU7UUFBVixTQUFJLEdBQUosSUFBSSxDQUFNO3VCQXZCSCxFQUFFO3dCQUNZLElBQUksZUFBZSxDQUFNLEVBQUUsQ0FBQzt1QkFFbkQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUU7MEJBRVYsRUFBRTswQkFFVCxDQUFDOzBCQUVELENBQUM7cUJBRU4sRUFBRTswQkFFRSxFQUFFOztnQ0FFQyxFQUFFOzswQkFJVixLQUFLO2lDQUVNLEVBQUU7NkJBQ1AsRUFBRTtLQUc3Qjs7Ozs7SUFFTSxvQkFBb0IsQ0FBQyxNQUFVO1FBQ3BDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxNQUFNLENBQUU7Ozs7Ozs7SUFRNUIsT0FBTyxDQUFDLEdBQVU7UUFDckIscUJBQUksT0FBTyxHQUFZLElBQUksT0FBTyxFQUFFLENBQUU7UUFDdEMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxjQUFjLEVBQUMsbUNBQW1DLENBQUMsQ0FBRTtRQUNwRSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFDLEVBQUMsT0FBTyxFQUFDLE9BQU8sRUFBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFB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LFNBQVMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO2dCQUM5QixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFFO2FBQ3ZCLEVBQUMsQ0FBQyxDQUFDLENBQUEsRUFBRTtnQkFDSixPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUU7YUFDYixDQUFDLENBQUMsQ0FBQTtTQUNKLENBQUMsQ0FBRTtLQUNMOzs7WUF6SkYsVUFBVTs7OztZQUhGLElBQUkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZScgO1xuaW1wb3J0IHsgSHR0cCxIZWFkZXJzLFJlc3BvbnNlfSBmcm9tICdAYW5ndWxhci9odHRwJyA7XG5pbXBvcnQgeyBtYXAscmV0cnkgfSBmcm9tICdyeGpzL29wZXJhdG9ycycgO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSxwaXBlLEJlaGF2aW9yU3ViamVjdCxTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBGbHhVaURhdGF0YWJsZVNlcnZpY2V7XG4gIC8vVXNlciBkYXRhIEFQSSB1cmxcbiAgcHJpdmF0ZSBkYXRhVXJsOiBzdHJpbmcgPSAnJyA7XG4gIHB1YmxpYyBiZWhhdmlvcjogQmVoYXZpb3JTdWJqZWN0PGFueT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGFueT4oW10pIDtcbiAgLy9Ib2xkIGFsbCBkYXRhIGZyb20gQVBJXG4gIHB1YmxpYyBmbHhEYXRhID0gdGhpcy5iZWhhdmlvci5hc09ic2VydmFibGUoKTsgIFxuICAvL0hlYWRlciBzZWxlY3QgcGFnaW5hdGlvblxuICBwdWJsaWMgcGFnaW5hdGlvbjogQXJyYXk8T2JqZWN0PiA9IFtdIDtcbiAgLy9Ib2xkIHRvdGFsIGl0ZW1zIGxvYWRlZCBmcm9tIEFQSVxuICBwdWJsaWMgdG90YWxJdGVtczogbnVtYmVyID0gMCA7XG4gIC8vS2VlcCB0cmFjayBvZiBjdXJyZW50IHBhZ2luYXRpb24gb2Zmc2V0XG4gIHB1YmxpYyBkYXRhT2Zmc2V0OiBudW1iZXIgPSAwIDtcbiAgLy9Vc2VyIGRlZmluZWQgbGltaXQgZm9yIG51bWJlciBvZiBpdGVtcyBwZXIgcGFnaW5hdGlvblxuICBwdWJsaWMgbGltaXQ6IG51bWJlciA9IDIwIDtcbiAgLy9EYXRhIHNvdXJjZSBrZXkgdG8gcmVhZCBmcm9tIEFQSSBwYXlsb2FkIHJlc3BvbnNlXG4gIHB1YmxpYyBkYXRhU3JjS2V5OnN0cmluZyA9ICcnO1xuICAvL0hvbGQgaXRlbXMgc2VsZWN0ZWQgZm9yIG11bHRpcGxlIHNlbGVjdFxuICBtdWx0aXBsZURlbGV0aW9uOkFycmF5PGFueT4gPSBbXSA7XG4gIC8vSG9sZCBzdWJzY3JpcHRpb24gb2YgYXBpIGNhbGxzIHdoaWNoIGNhbiBiZSBjYW5jZWQgYnkgY2FsbGluZyBjYW5jZWxMb2FkaW5nKCkgXG4gIGxvYWRlcjogU3Vic2NyaXB0aW9uIDsgIFxuICAvL0tlZXAgdHJhY2sgaWYgQVBJIGNhbGwgaXMgY29tcGxldGVkXG4gIGxvYWRGaW5pc2g6IGJvb2xlYW4gPSBmYWxzZSA7XG4gIC8vIExhenkgbG9hZGluZyBjb25maWdcbiAgcHJpdmF0ZSBsYXp5bG9hZGluZ0NvbmZpZzogYW55ID0ge30gO1xuICBwdWJsaWMgcHJvY2Vzc2VkRGF0YTogYW55ID0ge30gO1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgaHR0cDogSHR0cCl7XG4gICAgICBcbiAgfVxuXG4gIHB1YmxpYyBzZXRMYXp5bG9hZGluZ0NvbmZpZyhjb25maWc6YW55KXtcbiAgICB0aGlzLmxhenlsb2FkaW5nQ29uZmlnID0gY29uZmlnIDtcbiAgfVxuXG4gIC8vR0VUIHJlcXVlc3QgdG8gdXNlcidzIEFQSSB1cmxcbiAgLyoqXG4gICAqIFxuICAgKiBAcGFyYW0gdXJsIFVzZXIgYXBpIHJ1bFxuICAgKi9cbiAgcHVibGljIGdldERhdGEodXJsOnN0cmluZyk6IE9ic2VydmFibGU8YW55PntcbiAgICAgIGxldCBoZWFkZXJzOiBIZWFkZXJzID0gbmV3IEhlYWRlcnMoKSA7XG4gICAgICBoZWFkZXJzLmFwcGVuZCgnQ29udGVudC1UeXBlJywnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJykgO1xuICAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsLHtoZWFkZXJzOmhlYWRlcnN9KS5waXBlKHJldHJ5KDUpLG1hcCgocmVzcG9uc2U6IFJlc3BvbnNlKSA9PiByZXNwb25zZS5qc29uKCkpKSA7XG4gIH1cblxuICAvL1Bvc3QgcmVxdWVzdCBmb3IgZGF0YSBleHBvcnRcbiAgLyoqXG4gICAqIFxuICAgKiBAcGFyYW0gdXJsIFNlcnZpY2UgYXBpIHVybFxuICAgKiBAcGFyYW0gaWQgRGF0YXR5cGUgaWQgdG8gZXhwb3J0XG4gICAqIEBwYXJhbSBkYXRhIERhdGEgdG8gZXhwb3J0XG4gICAqL1xuICBwdWJsaWMgcG9zdERhdGEodXJsOnN0cmluZyxpZDphbnksZGF0YTpzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT57XG4gICAgbGV0IGhlYWRlcnM6IEhlYWRlcnMgPSBuZXcgSGVhZGVycygpIDtcbiAgICBoZWFkZXJzLmFwcGVuZCgnQ29udGVudC1UeXBlJywnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCcpIDtcbiAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QodXJsK2lkLGRhdGEse2hlYWRlcnM6aGVhZGVyc30pLnBpcGUobWFwKChyZXNwOiBSZXNwb25zZSkgPT4gcmVzcC5qc29uKCkpKSA7XG4gIH1cblxuICAvKipcbiAgICogXG4gICAqIEBwYXJhbSBkYXRhVXJsIFNldCBkYXRhdXJsXG4gICAqL1xuICBwdWJsaWMgc2V0RGF0YVVybChkYXRhVXJsOnN0cmluZyk6dm9pZHtcbiAgICB0aGlzLmRhdGFVcmwgPSBkYXRhVXJsIDtcbiAgfVxuXG4gIC8vR2V0IGRhdGEgdXJsIFxuICBwdWJsaWMgZ2V0RGF0YVVybCgpOnN0cmluZ3tcbiAgICByZXR1cm4gdGhpcy5kYXRhVXJsIDtcbiAgfVxuXG4gIC8qKlxuICAgKiBcbiAgICogQHBhcmFtIGRhdGEgUmVnaXN0ZXIgbmV3IGRhdGEgZnJvbSB1c2VyIEFQSVxuICAgKi9cbiAgcHVibGljIGNoYWdlRGF0YVRhYmxlKGRhdGE6YW55KXtcbiAgICB0aGlzLmJlaGF2aW9yLm5leHQoZGF0YSkgO1xuICB9XG5cbiAgLyoqXG4gICAqIFxuICAgKiBAcGFyYW0gbnVtYmVyT2ZMaXN0IFRvdGFsIG51bWJlciBvZiBsaXN0XG4gICAqIEBwYXJhbSBsaW1pdCBQYWdpbmF0aW9uIGxpbWl0XG4gICAqL1xuICBwcml2YXRlIGNyZWF0ZVBhZ2luYXRpb24obnVtYmVyT2ZMaXN0Om51bWJlcixsaW1pdDpudW1iZXIpOiBBcnJheTxPYmplY3Q+e1xuICAgIGxldCBvYmo6IEFycmF5PE9iamVjdD4gPSBbXSA7XG4gICAgbGV0IGNvdW50ZXI6IG51bWJlciA9IDEgO1xuICAgIGZvcihsZXQgaT0wO2k8bnVtYmVyT2ZMaXN0O2krPWxpbWl0KXtcbiAgICAgICAgb2JqLnB1c2goe2xhYmVsOmNvdW50ZXIsdmFsdWU6aX0pIDtcbiAgICAgICAgY291bnRlcisrIDtcbiAgICB9XG4gICAgaWYoIXRoaXMuaXNMYXp5TG9hZGluZ0VuYWJsZWQpe1xuICAgICAgb2JqLnB1c2goeyBsYWJlbDogJ0FsbCcsIHZhbHVlOiAnYWxsJyB9KTtcbiAgICB9XG4gICAgcmV0dXJuIG9iaiA7XG4gIH1cblxuICBwdWJsaWMgaXNMYXp5TG9hZGluZ0VuYWJsZWQoKXtcbiAgICByZXR1cm4gdGhpcy5sYXp5bG9hZGluZ0NvbmZpZy5oYXNPd25Qcm9wZXJ0eShcImFwaU9mZnNldEtleVwiKSAmJiB0aGlzLmxhenlsb2FkaW5nQ29uZmlnLmFwaU9mZnNldEtleSA7XG4gIH1cblxuICAvL0V2ZW50IHRvIGxvYWQgZGF0YSBmcm9tIHVzZXJzIGFwaVxuICBwdWJsaWMgbG9hZEZseERhdGFUYWJsZURhdGEoZGF0YVVybDpzdHJpbmcsc2V0U2VsZWN0UGFnaW5hdGlvbjpib29sZWFuPXRydWUpe1xuICAgIHRoaXMubG9hZEZpbmlzaCA9IGZhbHNlIDtcbiAgICAgIHRoaXMubG9hZGVyID0gdGhpcy5nZXREYXRhKGRhdGFVcmwpLnN1YnNjcmliZSgocmVzcG9uc2VEYXRhKSA9PiB7XG4gICAgICAgICAgdHJ5e1xuICAgICAgICAgICAgICB0aGlzLm11bHRpcGxlRGVsZXRpb24gPSBbXSA7XG4gICAgICAgICAgICAgIHZhciBkYXRhID0gKHRoaXMuZGF0YVNyY0tleSkgPyByZXNwb25zZURhdGFbdGhpcy5kYXRhU3JjS2V5XSA6IHJlc3BvbnNlRGF0YTtcbiAgICAgICAgICAgICAgdGhpcy5jaGFnZURhdGFUYWJsZShkYXRhKSA7XG4gICAgICAgICAgICAgIGlmKHRoaXMuaXNMYXp5TG9hZGluZ0VuYWJsZWQoKSl7ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRoaXMudG90YWxJdGVtcyA9IHJlc3BvbnNlRGF0YS50b3RhbCA7XG4gICAgICAgICAgICAgICAgLy8gSGFuZGxlIDEgcGFnaW5hdGlvbiBvdXQgb2YgemVybyBwcm9ibGVtIDEvMCAgaW5zdGVhZCBvZiAwLzAgaWYgbm8gZGF0YSBpcyBjb21taW5nXG4gICAgICAgICAgICAgICAgaWYoZGF0YS5sZW5ndGg+MCl7XG4gICAgICAgICAgICAgICAgICB0aGlzLmRhdGFPZmZzZXQgPSB0aGlzLmRhdGFPZmZzZXQrdGhpcy5saW1pdDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHRoaXMudG90YWxJdGVtcyA9IGRhdGEubGVuZ3RoIDtcbiAgICAgICAgICAgICAgICB0aGlzLmRhdGFPZmZzZXQgPSAxO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmKHNldFNlbGVjdFBhZ2luYXRpb24pe1xuICAgICAgICAgICAgICAgIGlmKHRoaXMuaXNMYXp5TG9hZGluZ0VuYWJsZWQoKSl7XG4gICAgICAgICAgICAgICAgICB0aGlzLnBhZ2luYXRpb24gPSB0aGlzLmNyZWF0ZVBhZ2luYXRpb24ocmVzcG9uc2VEYXRhLnRvdGFsLCB0aGlzLmxpbWl0KTtcbiAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgIHRoaXMucGFnaW5hdGlvbiA9IHRoaXMuY3JlYXRlUGFnaW5hdGlvbihkYXRhLmxlbmd0aCwgdGhpcy5saW1pdCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHRoaXMubG9hZEZpbmlzaCA9IHRydWU7XG4gICAgICAgICAgfWNhdGNoKGUpe1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRXJyb3IgaW4gcmVhZGluZyBkYXRhIGluICcsZSkgO1xuICAgICAgICAgIH1cbiAgICAgIH0sKGUgPT4ge1xuICAgICAgICAgIHRoaXMubG9hZEZpbmlzaCA9IHRydWUgO1xuICAgICAgfSkpXG4gIH1cblxuICAvL0NhbmNlbCBhcGkgR0VUIHJlcXVlc3QgdG8gYXBpXG4gIHB1YmxpYyBjYW5jZWxMb2FkaW5nKCl7XG4gICAgdGhpcy5sb2FkZXIudW5zdWJzY3JpYmUoKSA7XG4gIH0gIFxuXG4gIC8vU2V0IHNvdXJjZSBrZXkgdG8gcmVhZCBmcm9tIHBheWxvYWQgcmVzcG9uc2UgSlNPTlxuICBzZXREYXRhU3JjS2V5KHNyY0tleTpzdHJpbmcpOnZvaWQge1xuICAgIHRoaXMuZGF0YVNyY0tleSA9IHNyY0tleTtcbiAgfVxuXG4gIGdldERhdGFMZW5ndGgoKTogUHJvbWlzZTxudW1iZXI+e1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxudW1iZXI+KChyZXNvbHZlKSA9PntcbiAgICAgIHRoaXMuZmx4RGF0YS5zdWJzY3JpYmUoKHJlc3ApID0+e1xuICAgICAgICByZXNvbHZlKHJlc3AubGVuZ3RoKSA7XG4gICAgICB9LChlPT57XG4gICAgICAgIHJlc29sdmUoMCkgO1xuICAgICAgfSkpXG4gICAgfSkgO1xuICB9XG59Il19